name: Terraform Datadog

on:
  push:
    branches:
      - main
    paths:
      - 'infra/datadog/**'
      - '.github/workflows/terraform-datadog.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'infra/datadog/**'
      - '.github/workflows/terraform-datadog.yml'

env:
  TF_VERSION: '1.5.7'
  TF_WORKING_DIR: 'infra/datadog'

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest

    if: github.event_name == 'pull_request'

    # Use environment for secrets
    environment: datadog-production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Terraform Validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan -no-color -out=tfplan 2>&1 | tee plan_output.txt
          echo "exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        env:
          TF_VAR_datadog_api_key: ${{ secrets.DATADOG_API_KEY }}
          TF_VAR_datadog_app_key: ${{ secrets.DATADOG_APP_KEY }}
        continue-on-error: true

      - name: Comment Plan on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planFile = '${{ env.TF_WORKING_DIR }}/plan_output.txt';
            let plan = '';

            try {
              plan = fs.readFileSync(planFile, 'utf8');
            } catch (e) {
              plan = 'Unable to read plan output';
            }

            const truncatedPlan = plan.length > 60000
              ? plan.substring(0, 60000) + '\n\n... (truncated)'
              : plan;

            const exitCode = '${{ steps.plan.outputs.exitcode }}';
            const status = exitCode === '0' ? 'âœ… Success' : 'âŒ Failed';

            const output = `## Terraform Plan for Datadog ğŸ“Š

            **Environment:** \`datadog-production\`
            **Result:** ${status}

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${truncatedPlan}
            \`\`\`

            </details>

            *Pushed by: @${{ github.actor }}*`;

            // Find existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Terraform Plan for Datadog')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: output
              });
            }

      - name: Fail if Plan Failed
        if: steps.plan.outputs.exitcode != '0'
        run: exit 1

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest

    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    # Use environment for secrets and optional approval gate
    environment: datadog-production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Terraform Plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform plan -no-color -out=tfplan
        env:
          TF_VAR_datadog_api_key: ${{ secrets.DATADOG_API_KEY }}
          TF_VAR_datadog_app_key: ${{ secrets.DATADOG_APP_KEY }}

      - name: Terraform Apply
        id: apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform apply -auto-approve tfplan
        env:
          TF_VAR_datadog_api_key: ${{ secrets.DATADOG_API_KEY }}
          TF_VAR_datadog_app_key: ${{ secrets.DATADOG_APP_KEY }}

      # Send deployment event to Datadog instead of direct Slack notification
      - name: Send Success Event to Datadog
        if: success()
        run: |
          curl -X POST "https://api.datadoghq.com/api/v1/events" \
            -H "Content-Type: application/json" \
            -H "DD-API-KEY: ${{ secrets.DATADOG_API_KEY }}" \
            -d '{
              "title": "Datadog Infrastructure Deployed",
              "text": "Terraform apply succeeded for Datadog infrastructure.\n\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "priority": "normal",
              "tags": ["env:production", "service:terraform", "team:platform", "status:success"],
              "alert_type": "success",
              "source_type_name": "github"
            }'
        env:
          DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}

      - name: Send Failure Event to Datadog
        if: failure()
        run: |
          curl -X POST "https://api.datadoghq.com/api/v1/events" \
            -H "Content-Type: application/json" \
            -H "DD-API-KEY: ${{ secrets.DATADOG_API_KEY }}" \
            -d '{
              "title": "Datadog Infrastructure Deploy FAILED",
              "text": "Terraform apply FAILED for Datadog infrastructure.\n\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "priority": "normal",
              "tags": ["env:production", "service:terraform", "team:platform", "status:failed"],
              "alert_type": "error",
              "source_type_name": "github"
            }'
        env:
          DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}

      - name: Output Dashboard URL
        if: success()
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "## Deployment Complete! ğŸ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Dashboard URL:" >> $GITHUB_STEP_SUMMARY
          terraform output -raw dashboard_url >> $GITHUB_STEP_SUMMARY || echo "Unable to get dashboard URL" >> $GITHUB_STEP_SUMMARY
