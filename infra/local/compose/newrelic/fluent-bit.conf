# =============================================================================
# Fluent Bit Configuration for New Relic Log Forwarding
# =============================================================================
# Label-based opt-in: Only containers with com.newrelic.logs="true" are collected
#
# How it works:
#   1. INPUT tails all Docker container logs from /var/lib/docker/containers
#   2. Docker filter enriches logs with container metadata (name, id, labels)
#   3. Grep filter keeps only containers with the opt-in label
#   4. OUTPUT sends to New Relic Logs API
#
# Label key derivation:
#   The docker filter flattens container labels into record keys by:
#   - Adding prefix: container_label_
#   - Replacing dots (.) with underscores (_)
#   - Replacing hyphens (-) with underscores (_)
#
#   Example: com.newrelic.logs -> container_label_com_newrelic_logs
#
# JSON preservation:
#   Structured JSON fields from workers (event, tier, error_code, duration_ms,
#   stage, etc.) are preserved in the log payload and forwarded to New Relic.
# =============================================================================

[SERVICE]
    Flush         5
    Daemon        Off
    Log_Level     ${LOG_LEVEL}
    Parsers_File  /fluent-bit/etc/parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

# -----------------------------------------------------------------------------
# INPUT: Tail Docker container log files
# -----------------------------------------------------------------------------
# Reads JSON-formatted logs from Docker's default logging driver.
# Each container writes to /var/lib/docker/containers/<container_id>/<container_id>-json.log
# Docker_Mode handles multiline logs that Docker may split across JSON entries.
# -----------------------------------------------------------------------------
[INPUT]
    Name              tail
    Tag               docker.*
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Docker_Mode       On
    Docker_Mode_Flush 5
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  10
    DB                /var/log/flb_docker.db

# -----------------------------------------------------------------------------
# FILTER: Enrich with Docker metadata
# -----------------------------------------------------------------------------
# Adds container metadata to each log record via docker.sock:
#   - container_name: The container name (e.g., "lattice-mail-parser")
#   - container_id: The full container ID
#   - container_image: The image name
#   - container_label_*: All container labels (flattened as described above)
# -----------------------------------------------------------------------------
[FILTER]
    Name           docker
    Match          docker.*

# -----------------------------------------------------------------------------
# FILTER: Keep only containers with opt-in label (label-based filtering)
# -----------------------------------------------------------------------------
# After docker metadata enrichment, container labels are available as:
#   container_label_<label_key_with_dots_and_hyphens_as_underscores>
#
# For our opt-in label:
#   Docker label:  com.newrelic.logs: "true"
#   Record key:    container_label_com_newrelic_logs
#   Expected value: "true"
#
# This filter drops all logs from containers WITHOUT the opt-in label.
# -----------------------------------------------------------------------------
[FILTER]
    Name    grep
    Match   docker.*
    Regex   container_label_com_newrelic_logs ^true$

# -----------------------------------------------------------------------------
# FILTER: Add standard metadata fields
# -----------------------------------------------------------------------------
[FILTER]
    Name          modify
    Match         docker.*
    Add           project lattice
    Add           environment ${LATTICE_ENV}
    Add           logtype docker

# -----------------------------------------------------------------------------
# FILTER: Nest container metadata for cleaner structure
# -----------------------------------------------------------------------------
[FILTER]
    Name          nest
    Match         docker.*
    Operation     nest
    Wildcard      container_*
    Nest_under    docker

# -----------------------------------------------------------------------------
# OUTPUT: Send to New Relic Logs API
# -----------------------------------------------------------------------------
# Endpoint determined by NEW_RELIC_REGION (set by entrypoint):
#   US: https://log-api.newrelic.com/log/v1
#   EU: https://log-api.eu.newrelic.com/log/v1
#
# Authentication uses X-License-Key header with your New Relic ingest license key.
# The JSON payload preserves all structured fields from worker logs.
# -----------------------------------------------------------------------------
[OUTPUT]
    Name              http
    Match             docker.*
    Host              ${NEW_RELIC_LOG_HOST}
    Port              443
    URI               /log/v1
    Format            json
    Json_date_key     timestamp
    Json_date_format  epoch
    Header            X-License-Key ${NEW_RELIC_LICENSE_KEY}
    Header            Content-Type application/json
    Compress          gzip
    tls               On
    tls.verify        On
    Retry_Limit       5
