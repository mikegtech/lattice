# =============================================================================
# Fluent Bit Configuration for New Relic Log Forwarding
# =============================================================================
# Label-based opt-in: Only containers with com.newrelic.logs="true" are collected
# =============================================================================

[SERVICE]
    Flush         5
    Daemon        Off
    Log_Level     ${LOG_LEVEL}
    Parsers_File  /fluent-bit/etc/parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

# -----------------------------------------------------------------------------
# INPUT: Tail Docker container log files
# -----------------------------------------------------------------------------
[INPUT]
    Name              tail
    Tag               docker.*
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Docker_Mode       On
    Docker_Mode_Flush 5
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  10
    DB                /var/log/flb_docker.db

# -----------------------------------------------------------------------------
# FILTER: Enrich with Docker metadata (container name, labels, etc.)
# -----------------------------------------------------------------------------
[FILTER]
    Name           docker
    Match          docker.*
    # This enriches logs with container_name, container_id, and labels

# -----------------------------------------------------------------------------
# FILTER: Keep only containers with opt-in label
# Container labels are flattened to: container_label_<label_name_with_underscores>
# com.newrelic.logs -> container_label_com_newrelic_logs
# -----------------------------------------------------------------------------
[FILTER]
    Name    grep
    Match   docker.*
    Regex   container_label_com_newrelic_logs ^true$

# -----------------------------------------------------------------------------
# FILTER: Add standard metadata fields
# -----------------------------------------------------------------------------
[FILTER]
    Name          modify
    Match         docker.*
    Add           project lattice
    Add           environment ${LATTICE_ENV}
    Add           logtype docker

# -----------------------------------------------------------------------------
# FILTER: Nest container metadata for cleaner structure
# -----------------------------------------------------------------------------
[FILTER]
    Name          nest
    Match         docker.*
    Operation     nest
    Wildcard      container_*
    Nest_under    docker

# -----------------------------------------------------------------------------
# OUTPUT: Send to New Relic Logs API
# US: https://log-api.newrelic.com/log/v1
# EU: https://log-api.eu.newrelic.com/log/v1
# -----------------------------------------------------------------------------
[OUTPUT]
    Name              http
    Match             docker.*
    Host              ${NEW_RELIC_LOG_HOST}
    Port              443
    URI               /log/v1
    Format            json
    Json_date_key     timestamp
    Json_date_format  epoch
    Header            Api-Key ${NEW_RELIC_LICENSE_KEY}
    Header            Content-Type application/json
    Compress          gzip
    tls               On
    tls.verify        On
    Retry_Limit       5
