# =============================================================================
# Fluent Bit Configuration for New Relic Log Forwarding
# =============================================================================
# Collects Docker container logs and forwards to New Relic Logs API.
#
# How it works:
#   1. INPUT tails all Docker container logs from /var/lib/docker/containers
#   2. Logs are parsed as JSON (Docker's default log format)
#   3. Container name is extracted from the log file path
#   4. Only containers with names matching "lattice-*" are forwarded
#   5. OUTPUT sends to New Relic Logs API
#
# Container filtering:
#   - Filters by container name prefix "lattice-" (all Lattice workers)
#   - To change filtering, modify the Regex in the grep filter
#
# JSON preservation:
#   Structured JSON fields from workers (event, tier, error_code, duration_ms,
#   stage, etc.) are preserved in the log payload and forwarded to New Relic.
# =============================================================================

[SERVICE]
    Flush         5
    Daemon        Off
    Log_Level     ${LOG_LEVEL}
    Parsers_File  /fluent-bit/etc/parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

# -----------------------------------------------------------------------------
# INPUT: Tail Docker container log files
# -----------------------------------------------------------------------------
# Path format: /var/lib/docker/containers/<container_id>/<container_id>-json.log
# Tag format: docker.<container_id> (first 12 chars)
# -----------------------------------------------------------------------------
[INPUT]
    Name              tail
    Tag               docker.<container_id>
    Tag_Regex         (?<container_id>[a-z0-9]{12})
    Path              /var/lib/docker/containers/*/*.log
    Path_Key          log_path
    Parser            docker
    Docker_Mode       On
    Docker_Mode_Flush 5
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  10
    DB                /var/log/flb_docker.db

# -----------------------------------------------------------------------------
# FILTER: Keep only Lattice worker containers
# -----------------------------------------------------------------------------
# Filter by log path containing "lattice-" in the container name.
# Docker stores logs at: /var/lib/docker/containers/<id>/<id>-json.log
# Container names with "lattice-" prefix will have that in their inspect metadata.
#
# Note: This filters based on tag pattern. The tag contains container ID.
# For more precise filtering, we check if log content indicates a Lattice worker.
# -----------------------------------------------------------------------------
[FILTER]
    Name          grep
    Match         docker.*
    Regex         log ^\{.*"(level|msg|time)".*\}$

# -----------------------------------------------------------------------------
# FILTER: Parse nested JSON log content
# -----------------------------------------------------------------------------
# Docker wraps the actual log in: {"log": "<actual log content>", "stream": "...", "time": "..."}
# This extracts and parses the inner JSON from workers.
# -----------------------------------------------------------------------------
[FILTER]
    Name          parser
    Match         docker.*
    Key_Name      log
    Parser        json
    Reserve_Data  On

# -----------------------------------------------------------------------------
# FILTER: Add standard metadata fields
# -----------------------------------------------------------------------------
[FILTER]
    Name          modify
    Match         docker.*
    Add           project lattice
    Add           environment ${LATTICE_ENV}
    Add           logtype docker

# -----------------------------------------------------------------------------
# FILTER: Normalize service name for New Relic
# -----------------------------------------------------------------------------
# Worker logs have "service" field (e.g., "lattice-worker-mail-embedder")
# Copy to service_name for New Relic's standard field naming.
# For logs without service (like KafkaJS), clientId can be used to identify.
# Query in New Relic: service LIKE 'lattice-%' OR clientId IS NOT NULL
# -----------------------------------------------------------------------------
[FILTER]
    Name          modify
    Match         docker.*
    Copy          service service_name

# -----------------------------------------------------------------------------
# OUTPUT: Send to New Relic Logs API
# -----------------------------------------------------------------------------
# Endpoint: https://log-api.newrelic.com/log/v1 (US)
#           https://log-api.eu.newrelic.com/log/v1 (EU)
#
# Authentication uses X-License-Key header with your New Relic ingest license key.
# The JSON payload preserves all structured fields from worker logs.
# -----------------------------------------------------------------------------
[OUTPUT]
    Name              http
    Match             docker.*
    Host              ${NEW_RELIC_LOG_HOST}
    Port              443
    URI               /log/v1
    Format            json
    Json_date_key     timestamp
    Json_date_format  epoch
    Header            X-License-Key ${NEW_RELIC_LICENSE_KEY}
    Header            Content-Type application/json
    Compress          gzip
    tls               On
    tls.verify        On
    Retry_Limit       5
